<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Chatbot p√©dagogique</title>

<style>
:root{
  --primary:#0d6efd;
  --bg:#fafafa;
  --bubble:#ffffff;
  --border:#e0e0e0;
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  background:var(--bg);
}
#chat{display:flex;flex-direction:column;height:100vh}
#header{
  padding:10px 14px;background:#fff;border-bottom:1px solid var(--border);
  font-weight:600;display:flex;justify-content:space-between;align-items:center;gap:10px
}
#status{font-size:12px;opacity:.65;font-weight:500;white-space:nowrap}
#messages{flex:1;padding:12px;overflow-y:auto}
.msg{
  max-width:85%;padding:8px 12px;border-radius:12px;margin-bottom:8px;
  line-height:1.25;font-size:14px;white-space:pre-wrap;word-wrap:break-word
}
.bot{background:var(--bubble);border:1px solid var(--border)}
.user{background:var(--primary);color:#fff;margin-left:auto}
#typing{font-size:12px;opacity:.6;padding:0 12px 6px;display:none}
#form{
  display:flex;padding:8px;border-top:1px solid var(--border);background:#fff;gap:6px
}
#input{
  flex:1;padding:8px 10px;font-size:14px;border-radius:8px;border:1px solid var(--border);outline:none
}
#input:focus{border-color:#b9d1ff;box-shadow:0 0 0 3px rgba(13,110,253,.12)}
#send{
  padding:8px 14px;border:none;border-radius:8px;background:var(--primary);color:#fff;cursor:pointer
}
#send:disabled{opacity:.6;cursor:not-allowed}
.small{font-size:12px;opacity:.7;padding:0 12px 10px}
hr.sep{border:0;border-top:1px dashed rgba(0,0,0,.12);margin:10px 0}
code.k{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;font-size:12px}
</style>
</head>

<body>
<div id="chat">
  <div id="header">
    <div>ü§ñ Assistant p√©dagogique</div>
    <div id="status">Pr√™t</div>
  </div>

  <div id="messages">
    <div class="msg bot">Bonjour üëã Pose ta question.</div>
  </div>

  <div id="typing">‚è≥ L‚Äôassistant r√©pond‚Ä¶</div>
  <div class="small">Propuls√© par n8n</div>

  <form id="form">
    <input id="input" placeholder="√âcris ton message‚Ä¶" autocomplete="off" />
    <button id="send" type="submit">Envoyer</button>
  </form>
</div>

<script>
(function(){
  const WEBHOOK = "https://sisofficine.app.n8n.cloud/webhook/200ac8f9-bce6-449b-be38-7eca5bd26199";

  const msgs   = document.getElementById("messages");
  const form   = document.getElementById("form");
  const input  = document.getElementById("input");
  const send   = document.getElementById("send");
  const typing = document.getElementById("typing");
  const status = document.getElementById("status");

  const sessionId =
    localStorage.getItem("n8n_session")
    || (localStorage.setItem("n8n_session", "sess_" + Date.now()), localStorage.getItem("n8n_session"));

  function setStatus(t){ status.textContent = t; }

  function add(text, who){
    const d = document.createElement("div");
    d.className = "msg " + who;
    d.textContent = text;
    msgs.appendChild(d);
    msgs.scrollTop = msgs.scrollHeight;
  }

  // Cherche une "r√©ponse" dans n'importe quelle structure JSON (tr√®s robuste)
  function findFirstReply(data){
    const keysPriority = [
      "reply","response","output","text","answer","message","content"
    ];

    const seen = new Set();

    function walk(x){
      if (x === null || x === undefined) return null;

      // string directe
      if (typeof x === "string") {
        const s = x.trim();
        return s ? s : null;
      }

      // nombre/bool -> string
      if (typeof x === "number" || typeof x === "boolean") return String(x);

      // anti-boucle
      if (typeof x === "object") {
        if (seen.has(x)) return null;
        seen.add(x);
      }

      // tableau
      if (Array.isArray(x)) {
        for (const item of x) {
          const r = walk(item);
          if (r) return r;
        }
        return null;
      }

      // objet
      if (typeof x === "object") {
        // 1) on teste d'abord les cl√©s prioritaires
        for (const k of keysPriority) {
          if (k in x) {
            const r = walk(x[k]);
            if (r) return r;
          }
        }
        // 2) puis toutes les autres cl√©s
        for (const k of Object.keys(x)) {
          const r = walk(x[k]);
          if (r) return r;
        }
      }

      return null;
    }

    return walk(data);
  }

  async function readResponse(res){
    const ct = (res.headers.get("content-type") || "").toLowerCase();
    let rawText = "";
    let data = null;

    // On lit toujours le texte brut (utile si JSON foire)
    rawText = await res.text();

    // Tentative JSON
    if (ct.includes("application/json") || rawText.trim().startsWith("{") || rawText.trim().startsWith("[")) {
      try { data = JSON.parse(rawText); } catch { data = null; }
    }

    return { rawText, data };
  }

  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    const q = (input.value || "").trim();
    if(!q) return;

    add(q, "user");
    input.value = "";

    send.disabled = true;
    typing.style.display = "block";
    setStatus("Envoi‚Ä¶");

    try{
      const res = await fetch(WEBHOOK, {
        method: "POST",
        mode: "cors",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          message: q,
          sessionId,
          source: "github-pages",
          referrer: document.referrer || "",
          pageUrl: location.href
        })
      });

      setStatus(`HTTP ${res.status}`);

      const { rawText, data } = await readResponse(res);

      // Si HTTP pas OK, on affiche le body brut
      if (!res.ok) {
        add(`‚ùå Erreur HTTP ${res.status}\n\n${rawText || "(body vide)"}`, "bot");
        return;
      }

      const reply = data ? findFirstReply(data) : (rawText || "").trim();

      if (reply) {
        add(reply, "bot");
      } else {
        // Fallback DEBUG : on te montre exactement ce qui arrive dans le navigateur
        const dbg = data ? JSON.stringify(data, null, 2) : rawText;
        add("‚ö†Ô∏è R√©ponse re√ßue mais non reconnue.\nVoici le contenu brut :\n\n" + dbg, "bot");
      }

    } catch(err){
      setStatus("Erreur");
      add("‚ùå Erreur de connexion (CORS / r√©seau). Regarde la console du navigateur.", "bot");
      console.error(err);
    } finally {
      typing.style.display = "none";
      send.disabled = false;
      input.focus();
      setStatus("Pr√™t");
    }
  });

})();
</script>
</body>
</html>
