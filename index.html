<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Chatbot p√©dagogique</title>

<style>
:root{
  --primary:#0d6efd;
  --bg:#fafafa;
  --bubble:#ffffff;
  --border:#e0e0e0;
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  background:var(--bg);
}
#chat{display:flex;flex-direction:column;height:100vh}
#header{
  padding:10px 14px;
  background:#fff;
  border-bottom:1px solid var(--border);
  font-weight:600;
}
#messages{flex:1;padding:12px;overflow-y:auto}
.msg{
  max-width:85%;
  padding:8px 12px;
  border-radius:12px;
  margin-bottom:8px;
  line-height:1.25;
  font-size:14px;
  white-space:pre-wrap;
  word-wrap:break-word;
}
.bot{background:var(--bubble);border:1px solid var(--border)}
.user{background:var(--primary);color:#fff;margin-left:auto}
#typing{font-size:12px;opacity:.6;padding:0 12px 6px;display:none}
#form{
  display:flex;
  padding:8px;
  border-top:1px solid var(--border);
  background:#fff;
  gap:6px;
}
#input{
  flex:1;
  padding:8px 10px;
  font-size:14px;
  border-radius:8px;
  border:1px solid var(--border);
  outline:none;
}
#input:focus{
  border-color:#b9d1ff;
  box-shadow:0 0 0 3px rgba(13,110,253,.12);
}
#send{
  padding:8px 14px;
  border:none;
  border-radius:8px;
  background:var(--primary);
  color:#fff;
  cursor:pointer;
}
#send:disabled{opacity:.6;cursor:not-allowed}
.small{font-size:12px;opacity:.7;padding:0 12px 10px}
</style>
</head>

<body>
<div id="chat">
  <div id="header">ü§í Premier Patient</div>

  <div id="messages">
    <div class="msg bot">Bonjour üëã </div>
  </div>

  <div id="typing">‚è≥ Le patient r√©fl√©chit...</div>
  <div class="small">Patient virtuel IA</div>

  <form id="form">
    <input id="input" placeholder="Parler au patient..." autocomplete="off" />
    <button id="send" type="submit">Envoyer</button>
  </form>
</div>

<script>
(function(){
  const WEBHOOK = "https://sisofficine.app.n8n.cloud/webhook/200ac8f9-bce6-449b-be38-7eca5bd26198";

  const msgs   = document.getElementById("messages");
  const form   = document.getElementById("form");
  const input  = document.getElementById("input");
  const send   = document.getElementById("send");
  const typing = document.getElementById("typing");

  // Session persistante (m√©moire c√¥t√© n8n)
  const sessionId =
    localStorage.getItem("n8n_session")
    || (localStorage.setItem("n8n_session", "sess_" + Date.now()),
        localStorage.getItem("n8n_session"));

  function add(text, who){
    const d = document.createElement("div");
    d.className = "msg " + who;
    d.innerHTML = text
  .replace(/(https?:\/\/[^\s]+)/g,
    '<a href="$1" target="_blank" rel="noopener noreferrer">$1</a>')
  .replace(/\n/g, "<br>");
    msgs.appendChild(d);
    msgs.scrollTop = msgs.scrollHeight;
  }

  function extractReply(data){
    // Format n8n actuel : [ { output: "..." } ]
    if (Array.isArray(data) && data[0] && typeof data[0] === "object") {
      return data[0].output || data[0].reply || data[0].text || "";
    }
    // Fallbacks simples
    if (data && typeof data === "object") {
      return data.output || data.reply || data.text || "";
    }
    if (typeof data === "string") return data;
    return "";
  }

  form.addEventListener("submit", async (e)=>{
    e.preventDefault();
    const q = (input.value || "").trim();
    if(!q) return;

    add(q, "user");
    input.value = "";
    send.disabled = true;
    typing.style.display = "block";

    try{
      const res = await fetch(WEBHOOK, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          message: q,
          sessionId,
          source: "moodle-iframe",
          pageUrl: location.href
        })
      });

      const data = await res.json();
      const reply = extractReply(data);

      add(reply || "Aucune r√©ponse re√ßue.", "bot");
    } catch(err){
      add("‚ùå Erreur de connexion au serveur.", "bot");
      console.error(err);
    } finally {
      typing.style.display = "none";
      send.disabled = false;
      input.focus();
    }
  });
})();
</script>
</body>
</html>
