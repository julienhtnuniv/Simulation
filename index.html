<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Chatbot p√©dagogique</title>

<style>
:root{
  --primary:#0d6efd;
  --bg:#fafafa;
  --bubble:#ffffff;
  --border:#e0e0e0;
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  background:var(--bg);
}
#chat{display:flex;flex-direction:column;height:100vh}
#header{
  padding:10px 14px;
  background:#fff;
  border-bottom:1px solid var(--border);
  font-weight:600;
}
#messages{flex:1;padding:12px;overflow-y:auto}
.msg{
  max-width:85%;
  padding:8px 12px;
  border-radius:12px;
  margin-bottom:8px;
  line-height:1.25;
  font-size:14px;
  white-space:pre-wrap;
  word-wrap:break-word;
}
.bot{background:var(--bubble);border:1px solid var(--border)}
.user{background:var(--primary);color:#fff;margin-left:auto}
#typing{font-size:12px;opacity:.6;padding:0 12px 6px;display:none}
#form{
  display:flex;
  padding:8px;
  border-top:1px solid var(--border);
  background:#fff;
  gap:6px;
}
#input{
  flex:1;
  padding:8px 10px;
  font-size:14px;
  border-radius:8px;
  border:1px solid var(--border);
  outline:none;
}
#input:focus{
  border-color:#b9d1ff;
  box-shadow:0 0 0 3px rgba(13,110,253,.12);
}
#send{
  padding:8px 14px;
  border:none;
  border-radius:8px;
  background:var(--primary);
  color:#fff;
  cursor:pointer;
}
#send:disabled{opacity:.6;cursor:not-allowed}
.small{font-size:12px;opacity:.7;padding:0 12px 10px}
</style>
</head>

<body>
<div id="chat">
  <div id="header">ü§ñ Assistant p√©dagogique</div>

  <div id="messages">
    <div class="msg bot">Bonjour üëã Pose ta question.</div>
  </div>

  <div id="typing">‚è≥ L‚Äôassistant r√©pond‚Ä¶</div>
  <div class="small">Propuls√© par n8n</div>

  <form id="form">
    <input id="input" placeholder="√âcris ton message‚Ä¶" autocomplete="off" />
    <button id="send" type="submit">Envoyer</button>
  </form>
</div>

<script>
(function(){
  const WEBHOOK = "https://sisofficine.app.n8n.cloud/webhook/200ac8f9-bce6-449b-be38-7eca5bd26198";

  const msgs   = document.getElementById("messages");
  const form   = document.getElementById("form");
  const input  = document.getElementById("input");
  const send   = document.getElementById("send");
  const typing = document.getElementById("typing");

  // Session persistante (m√©moire c√¥t√© n8n)
  const sessionId =
    localStorage.getItem("n8n_session")
    || (localStorage.setItem("n8n_session", "sess_" + Date.now()),
        localStorage.getItem("n8n_session"));

  // ‚úÖ R√©cup√©ration des balises depuis l'URL : ?firstname=...&lastname=...
  const params = new URLSearchParams(location.search);

  // Si non fourni, on laisse null (et tu g√®res c√¥t√© n8n)
  const firstname = params.get("firstname");
  const lastname  = params.get("lastname");

  function add(text, who){
    const d = document.createElement("div");
    d.className = "msg " + who;

    // ‚úÖ Bouton T√©l√©charger si une URL est pr√©sente dans un message bot
    const urlMatch = text.match(/https?:\/\/[^\s]+/);

    if (urlMatch && who === "bot") {
      const url = urlMatch[0];
      const label = text.replace(url, "").trim();

      d.innerHTML = `
        ${label ? `<div style="margin-bottom:6px">${escapeHtml(label).replace(/\n/g,"<br>")}</div>` : ""}
        <a href="${escapeAttr(url)}" target="_blank" rel="noopener noreferrer"
           style="
             display:inline-block;
             padding:8px 14px;
             background:#0d6efd;
             color:#fff;
             border-radius:8px;
             text-decoration:none;
             font-size:14px;
             font-weight:500;
           ">
          üìÑ T√©l√©charger le PDF
        </a>
      `;
    } else {
      d.textContent = text;
    }

    msgs.appendChild(d);
    msgs.scrollTop = msgs.scrollHeight;
  }

  function extractReply(data){
    // Format n8n courant : [ { output: "..." } ]
    if (Array.isArray(data) && data[0] && typeof data[0] === "object") {
      return data[0].output || data[0].reply || data[0].text || "";
    }
    if (data && typeof data === "object") {
      return data.output || data.reply || data.text || "";
    }
    if (typeof data === "string") return data;
    return "";
  }

  function escapeHtml(s){
    return String(s)
      .replace(/&/g,"&amp;")
      .replace(/</g,"&lt;")
      .replace(/>/g,"&gt;")
      .replace(/"/g,"&quot;")
      .replace(/'/g,"&#39;");
  }
  function escapeAttr(s){
    // suffisant ici (on √©chappe au minimum ce qui casse les attributs)
    return String(s).replace(/"/g,"&quot;");
  }

  form.addEventListener("submit", async (e)=>{
    e.preventDefault();
    const q = (input.value || "").trim();
    if(!q) return;

    add(q, "user");
    input.value = "";
    send.disabled = true;
    typing.style.display = "block";

    try{
      const res = await fetch(WEBHOOK, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          message: q,
          sessionId,
          // ‚úÖ envoy√©es √† n8n
          firstname,
          lastname,
          source: "moodle-iframe",
          pageUrl: location.href
        })
      });

      const data = await res.json();
      const reply = extractReply(data);

      add(reply || "Aucune r√©ponse re√ßue.", "bot");
    } catch(err){
      add("‚ùå Erreur de connexion au serveur.", "bot");
      console.error(err);
    } finally {
      typing.style.display = "none";
      send.disabled = false;
      input.focus();
    }
  });
})();
</script>
</body>
</html>
