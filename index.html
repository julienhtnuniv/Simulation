<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Chat patient</title>

<style>
:root{
  --primary:#4d4593;
  --bg:#fafafa;
  --bubble:#ffffff;
  --border:#e0e0e0;
}
*{box-sizing:border-box}
html, body{ height:100%; }

body{
  margin:0;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  background:var(--bg);
  overflow:hidden;
}

#chat{
  display:flex;
  flex-direction:column;
  height:100%;
}

#messages{
  flex:1;
  padding:12px;
  overflow-y:auto;
}

.msg{
  max-width:85%;
  padding:8px 12px;
  border-radius:12px;
  margin-bottom:8px;
  line-height:1.25;
  font-size:14px;
  white-space:pre-wrap;
  word-wrap:break-word;
}

.bot{
  background:var(--bubble);
  border:1px solid var(--border);
  color:#000;
}

.user{
  background:var(--primary);
  color:#fff;
  margin-left:auto;
}

#typing{
  font-size:12px;
  opacity:.6;
  padding:0 12px 6px;
  display:none;
}

.small{
  font-size:12px;
  opacity:.7;
  padding:0 12px 10px;
}

#form{
  display:flex;
  padding:8px;
  border-top:1px solid var(--border);
  background:#fff;
  gap:6px;
}

#input{
  flex:1;
  padding:8px 10px;
  font-size:14px;
  border-radius:8px;
  border:1px solid var(--border);
  outline:none;
}

#input:focus{
  border-color:#b9d1ff;
  box-shadow:0 0 0 3px rgba(77,69,147,.12);
}

#send{
  padding:8px 14px;
  border:none;
  border-radius:8px;
  background:var(--primary);
  color:#fff;
  cursor:pointer;
}

#send:disabled{
  opacity:.6;
  cursor:not-allowed;
}

.btnlink{
  display:inline-block;
  padding:8px 14px;
  background:var(--primary);
  color:#fff;
  border-radius:8px;
  text-decoration:none;
  font-size:14px;
  font-weight:500;
}
</style>
</head>

<body>
<div id="chat">

  <div id="messages">
    <div class="msg bot">Bonjour üëã</div>
  </div>

  <div id="typing">‚è≥ Le patient r√©fl√©chit...</div>
  <div class="small">(Patient cr√©√© par IA)</div>

  <form id="form">
    <input id="input" placeholder="Parler au patient..." autocomplete="off" />
    <button id="send" type="submit">Envoyer</button>
  </form>
</div>

<script>
window.addEventListener("DOMContentLoaded", () => {

  const WEBHOOK = "https://sisofficine.app.n8n.cloud/webhook/200ac8f9-bce6-449b-be38-7eca5bd26198";

  const msgs   = document.getElementById("messages");
  const form   = document.getElementById("form");
  const input  = document.getElementById("input");
  const send   = document.getElementById("send");
  const typing = document.getElementById("typing");

  const params = new URLSearchParams(location.search);
  const context   = params.get("context") || "default";
  const firstname = params.get("firstname") || "{firstname}";
  const lastname  = params.get("lastname")  || "{lastname}";

  const storageKey = "n8n_session_" + context;
  const sessionId =
    localStorage.getItem(storageKey)
    || (localStorage.setItem(
          storageKey,
          "sess_" + Date.now() + "_" + Math.random().toString(16).slice(2)
        ),
        localStorage.getItem(storageKey));

  function escapeHtml(s){
    return String(s)
      .replace(/&/g,"&amp;")
      .replace(/</g,"&lt;")
      .replace(/>/g,"&gt;")
      .replace(/"/g,"&quot;")
      .replace(/'/g,"&#39;");
  }

  function escapeAttr(s){
    return String(s).replace(/"/g,"&quot;");
  }

  function add(text, who){
    const d = document.createElement("div");
    d.className = "msg " + who;

    const urlMatch = (text || "").match(/https?:\/\/[^\s]+/);

    if (who === "bot" && urlMatch) {
      const url = urlMatch[0];
      const label = (text || "").replace(url, "").trim();

      d.innerHTML = `
        ${label ? `<div style="margin-bottom:6px">${escapeHtml(label).replace(/\n/g,"<br>")}</div>` : ""}
        <a class="btnlink" href="${escapeAttr(url)}" target="_blank" rel="noopener noreferrer">
          üìÑ T√©l√©charger
        </a>
      `;
    } else {
      d.textContent = text;
    }

    msgs.appendChild(d);
    msgs.scrollTop = msgs.scrollHeight;
  }

  function extractReply(data){
    if (Array.isArray(data) && data[0] && typeof data[0] === "object") {
      return data[0].output || data[0].reply || data[0].text || data[0].answer || data[0].message || "";
    }
    if (data && typeof data === "object") {
      return data.output || data.reply || data.text || data.answer || data.message || "";
    }
    if (typeof data === "string") return data;
    return "";
  }

  form.addEventListener("submit", async (e) => {
    e.preventDefault();

    const q = (input.value || "").trim();
    if (!q) return;

    add(q, "user");
    input.value = "";

    send.disabled = true;
    typing.style.display = "block";

    try{
      const res = await fetch(WEBHOOK, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          message: q,
          sessionId,
          context,
          firstname,
          lastname,
          source: "moodle-iframe",
          pageUrl: location.href
        })
      });

      const data = await res.json();
      const reply = extractReply(data);

      add(reply || "Aucune r√©ponse re√ßue.", "bot");
    } catch(err){
      add("‚ùå Erreur de connexion au serveur.", "bot");
    } finally {
      typing.style.display = "none";
      send.disabled = false;
      input.focus();
    }
  });

});
</script>
</body>
</html>
