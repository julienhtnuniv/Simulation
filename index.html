<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Chatbot Moodle ‚Üí n8n</title>

<style>
:root{
  --primary:#4d4593;
  --bg:#fafafa;
  --bubble:#ffffff;
  --border:#e0e0e0;
}
*{box-sizing:border-box}

html, body{ height:100%; }

body{
  margin:0;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  background:var(--bg);
  overflow:hidden; /* √©vite le ‚Äúfond‚Äù en dessous dans l‚Äôiframe */
}

#chat{
  display:flex;
  flex-direction:column;
  height:100%; /* prend exactement la hauteur de l'iframe */
}

#messages{
  flex:1;
  padding:12px;
  overflow-y:auto;
}

.msg{
  max-width:85%;
  padding:8px 12px;
  border-radius:12px;
  margin-bottom:8px;
  line-height:1.25;
  font-size:14px;
  white-space:pre-wrap;
  word-wrap:break-word;
}

.bot{background:var(--bubble);border:1px solid var(--border);color:#000}
.user{background:var(--primary);color:#fff;margin-left:auto}

#typing{font-size:12px;opacity:.6;padding:0 12px 6px;display:none}

#form{
  display:flex;
  padding:8px;
  border-top:1px solid var(--border);
  background:#fff;
  gap:6px;
}

#input{
  flex:1;
  padding:8px 10px;
  font-size:14px;
  border-radius:8px;
  border:1px solid var(--border);
  outline:none;
}

#input:focus{
  border-color:#b9d1ff;
  box-shadow:0 0 0 3px rgba(77,69,147,.12);
}

#send{
  padding:8px 14px;
  border:none;
  border-radius:8px;
  background:var(--primary);
  color:#fff;
  cursor:pointer;
}

#send:disabled{opacity:.6;cursor:not-allowed}

.small{font-size:12px;opacity:.7;padding:0 12px 10px}

.btnlink{
  display:inline-block;
  padding:8px 14px;
  background:var(--primary);
  color:#fff;
  border-radius:8px;
  text-decoration:none;
  font-size:14px;
  font-weight:500;
}
</style>
</head>

<body>
<div id="chat">

  <div id="messages">
    <div class="msg bot">Bonjour üëã</div>
  </div>

  <div id="typing">‚è≥ Le patient r√©fl√©chit...</div>
  <div class="small">(Patient cr√©√© par IA)</div>

  <form id="form">
    <input id="input" placeholder="Parler au patient..." autocomplete="off" />
    <button id="send" type="submit">Envoyer</button>
  </form>
</div>

<script>
(function(){
  // ‚ö†Ô∏è Remets ici TON webhook valide (dans ton historique c'√©tait ...26199)
  const WEBHOOK = "https://sisofficine.app.n8n.cloud/webhook/200ac8f9-bce6-449b-be38-7eca5bd26198";

  const msgs   = document.getElementById("messages");
  const form   = document.getElementById("form");
  const input  = document.getElementById("input");
  const send   = document.getElementById("send");
  const typing = document.getElementById("typing");

  // Params venant de l'iframe Moodle
  const params = new URLSearchParams(location.search);
  const context   = params.get("context") || "default";
  const firstname =
